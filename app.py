import streamlit as st
import pandas as pd
from datetime import datetime
import os

# --- 1. à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š ---
st.set_page_config(page_title="à¸£à¸°à¸šà¸šà¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸„à¸¸à¸¡à¹à¸¥à¸°à¸ªà¸£à¸¸à¸›à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“ à¸¡à¸žà¸¢.", layout="wide", page_icon="ðŸ›¡ï¸")

# à¸„à¹ˆà¸²à¸„à¸‡à¸—à¸µà¹ˆà¹à¸¥à¸°à¹„à¸Ÿà¸¥à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
DB_FILE = "database_claims.csv"

# à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸§à¸”à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“
BUDGET_OPTIONS = {
    "541010001": "à¸«à¸¡à¸§à¸”à¸ªà¹ˆà¸‡à¹€à¸ªà¸£à¸´à¸¡à¸à¸²à¸£à¸§à¸´à¸ˆà¸±à¸¢",
    "521130002": "à¸„à¹ˆà¸²à¸–à¹ˆà¸²à¸¢à¹€à¸­à¸à¸ªà¸²à¸£",
    "521130004": "à¸§à¸±à¸ªà¸”à¸¸à¸ªà¸´à¹‰à¸™à¹€à¸›à¸¥à¸·à¸­à¸‡à¸ªà¸³à¸™à¸±à¸à¸‡à¸²à¸™",
    "531111005": "à¸„à¹ˆà¸²à¸¢à¸²à¸™à¸žà¸²à¸«à¸™à¸°",
    "521140007": "à¸ªà¸±à¸¡à¸¡à¸™à¸²à¸ à¸²à¸¢à¹ƒà¸™",
    "531104002": "à¸„à¹ˆà¸²à¹„à¸›à¸£à¸©à¸“à¸µà¸¢à¸²à¸à¸£"
}

# --- 2. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸Šà¹ˆà¸§à¸¢à¸‡à¸²à¸™ (Helper Functions) ---

def get_current_thai_date():
    now = datetime.now()
    return now, now.year + 543, now.strftime(f"%d/%m/{now.year + 543}")

def get_next_doc_no():
    if not os.path.exists(DB_FILE):
        return "0203/001"
    try:
        df = pd.read_csv(DB_FILE)
        if df.empty: return "0203/001"
        
        now, thai_year, _ = get_current_thai_date()
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸›à¸µà¸¥à¹ˆà¸²à¸ªà¸¸à¸” (à¸•à¸±à¸”à¸£à¸­à¸š 1 à¸¡à¸à¸£à¸²à¸„à¸¡)
        last_year = int(df['à¸›à¸µ'].iloc[-1])
        if thai_year > last_year:
            return "0203/001"
            
        last_doc = str(df['à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸­à¸­à¸'].iloc[-1])
        new_num = int(last_doc.split('/')[-1]) + 1
        return f"0203/{new_num:03d}"
    except:
        return "0203/001"

def load_data():
    if os.path.exists(DB_FILE):
        df = pd.read_csv(DB_FILE)
        return df
    return pd.DataFrame()

# à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸„à¸³à¸™à¸§à¸“à¸›à¸µà¸•à¹ˆà¸²à¸‡à¹† à¸•à¸²à¸¡à¸à¸Žà¸‚à¸­à¸‡user
def calculate_period_columns(df):
    if df.empty: return df
    
    # à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¹ƒà¸«à¸¡à¹ˆà¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡
    df['à¸›à¸µà¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“'] = df.apply(lambda x: x['à¸›à¸µ'] + 1 if x['à¹€à¸”à¸·à¸­à¸™'] >= 8 else x['à¸›à¸µ'], axis=1)
    df['à¸›à¸µà¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²'] = df.apply(lambda x: x['à¸›à¸µ'] if x['à¹€à¸”à¸·à¸­à¸™'] >= 6 else x['à¸›à¸µ'] - 1, axis=1)
    
    # à¹€à¸žà¸´à¹ˆà¸¡à¸Šà¸·à¹ˆà¸­à¸«à¸¡à¸§à¸”à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“à¹€à¸‚à¹‰à¸²à¹„à¸›à¸”à¹‰à¸§à¸¢à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸”à¸¹à¸‡à¹ˆà¸²à¸¢
    df['à¸Šà¸·à¹ˆà¸­à¸«à¸¡à¸§à¸”'] = df['à¸£à¸«à¸±à¸ªà¸«à¸¡à¸§à¸”
