import streamlit as st
import pandas as pd
from datetime import datetime
import os
import io
import altair as alt
import requests

# --- Library à¸ªà¸³à¸«à¸£à¸±à¸š PDF ---
from pypdf import PdfReader, PdfWriter
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.pagesizes import A4

# ==========================================
# 1. à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸šà¸š (Configuration)
# ==========================================
st.set_page_config(page_title="à¸£à¸°à¸šà¸šà¸šà¸£à¸´à¸«à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“ à¸¡à¸žà¸¢.", layout="wide", page_icon="ðŸ›¡ï¸")

DB_FILE = "database_claims.csv"
TARGET_FILE = "budget_targets.csv"
TEMPLATE_PDF = "à¹ƒà¸šà¹€à¸šà¸´à¸.pdf"         
FONT_FILE = "THSarabunNew.ttf"       
FONT_URL = "https://github.com/gungunss/ThaiFonts/raw/master/THSarabunNew.ttf"

# --- ðŸŽ¯ à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸žà¸´à¸à¸±à¸”à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ (PDF CONFIG) à¸­à¸´à¸‡à¸•à¸²à¸¡à¹€à¸­à¸à¸ªà¸²à¸£à¸ˆà¸£à¸´à¸‡ ---
# (X = à¸‹à¹‰à¸²à¸¢à¹„à¸›à¸‚à¸§à¸², Y = à¸¥à¹ˆà¸²à¸‡à¸‚à¸¶à¹‰à¸™à¸šà¸™)
PDF_CONFIG = {
    # à¸ªà¹ˆà¸§à¸™à¸«à¸±à¸§
    "faculty":    (130, 775),  # à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™
    "doc_no":     (90, 755),   # à¸—à¸µà¹ˆ à¸¡à¸žà¸¢
    "date_day":   (380, 755),  # à¸§à¸±à¸™à¸—à¸µà¹ˆ
    "date_month": (440, 755),  # à¹€à¸”à¸·à¸­à¸™
    "date_year":  (510, 755),  # à¸ž.à¸¨.
    
    # à¹€à¸£à¸·à¹ˆà¸­à¸‡ à¹à¸¥à¸° à¹€à¸£à¸µà¸¢à¸™
    "subject":    (90, 725),   # à¹€à¸£à¸·à¹ˆà¸­à¸‡
    "to_who":     (90, 700),   # à¹€à¸£à¸µà¸¢à¸™ (à¸«à¸±à¸§à¸«à¸™à¹‰à¸²à¹à¸œà¸™à¸à¸à¸²à¸£à¹€à¸‡à¸´à¸™)
    
    # à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸¡à¸²à¸”à¹‰à¸§à¸¢
    "attach_1":   (130, 675),  
    
    # à¸•à¸´à¹Šà¸à¸Šà¹ˆà¸­à¸‡ "à¸‚à¸­à¹€à¸šà¸´à¸à¹€à¸‡à¸´à¸™" à¹à¸¥à¸°à¸¢à¸­à¸”à¹€à¸‡à¸´à¸™
    "check_req":  (73, 642),   # à¸žà¸´à¸à¸±à¸”à¸à¸²à¸à¸šà¸²à¸— (X) à¸«à¸™à¹‰à¸²à¸‚à¸­à¹€à¸šà¸´à¸à¹€à¸‡à¸´à¸™
    "amount":     (200, 615),  # à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™
    "amount_txt": (350, 615),  # à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£
    
    # à¸ªà¸±à¹ˆà¸‡à¸ˆà¹ˆà¸²à¸¢ à¹à¸¥à¸° à¸§à¸±à¸™à¸—à¸µà¹ˆà¸£à¸±à¸šà¹€à¸‡à¸´à¸™
    "pay_to":     (130, 585),  # à¸ªà¸±à¹ˆà¸‡à¸ˆà¹ˆà¸²à¸¢à¹ƒà¸«à¹‰
    "req_d":      (340, 585),  # à¸£à¸±à¸šà¹€à¸‡à¸´à¸™à¸§à¸±à¸™à¸—à¸µà¹ˆ
    "req_m":      (410, 585),  # à¸£à¸±à¸šà¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™
    "req_y":      (490, 585),  # à¸£à¸±à¸šà¹€à¸‡à¸´à¸™ à¸ž.à¸¨.
    
    # à¸šà¸±à¸à¸Šà¸µà¸˜à¸™à¸²à¸„à¸²à¸£
    "check_bank": (73, 532),   # à¸žà¸´à¸à¸±à¸”à¸à¸²à¸à¸šà¸²à¸— (X) à¹€à¸‚à¹‰à¸²à¸šà¸±à¸à¸Šà¸µà¸˜à¸™à¸²à¸„à¸²à¸£
    "bank_detail":(250, 532),  # à¸Šà¸·à¹ˆà¸­à¹à¸¥à¸°à¹€à¸¥à¸‚à¸šà¸±à¸à¸Šà¸µ
    
    # à¹‚à¸„à¸£à¸‡à¸à¸²à¸£ à¹à¸¥à¸° à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“
    "project":    (200, 502),  # à¹ƒà¸Šà¹‰à¹ƒà¸™à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸”à¸±à¸‡à¸™à¸µà¹‰
    "faculty_budget": (240, 472), # à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“à¸‚à¸­à¸‡à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™
    "check_budget": (73, 442), # à¸žà¸´à¸à¸±à¸”à¸à¸²à¸à¸šà¸²à¸— (X) à¸›à¸£à¸°à¹€à¸ à¸—à¸‡à¸š
    "budget_cat": (160, 442),  # à¸«à¸¡à¸§à¸”à¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“
    
    # à¸œà¸¹à¹‰à¹€à¸šà¸´à¸
    "leader":     (380, 340),  # à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸šà¸´à¸à¹€à¸‡à¸´à¸™
    "position":   (380, 315),  # à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡
}

# --- Master Data ---
BUDGET_MASTER = {
    "541010001": "à¸«à¸¡à¸§à¸”à¸ªà¹ˆà¸‡à¹€à¸ªà¸£à¸´à¸¡à¸à¸²à¸£à¸§à¸´à¸ˆà¸±à¸¢", "521130002": "à¸„à¹ˆà¸²à¸–à¹ˆà¸²à¸¢à¹€à¸­à¸à¸ªà¸²à¸£",
    "521130004": "à¸§à¸±à¸ªà¸”à¸¸à¸ªà¸´à¹‰à¸™à¹€à¸›à¸¥à¸·à¸­à¸‡à¸ªà¸³à¸™à¸±à¸à¸‡à¸²à¸™", "531111005": "à¸„à¹ˆà¸²à¸¢à¸²à¸™à¸žà¸²à¸«à¸™à¸°",
    "521140007": "à¸ªà¸±à¸¡à¸¡à¸™à¸²à¸ à¸²à¸¢à¹ƒà¸™", "531104002": "à¸„à¹ˆà¸²à¹„à¸›à¸£à¸©à¸“à¸µà¸¢à¸²à¸à¸£"
}

FACULTY_MASTER = [
    "à¸„à¸“à¸°à¸™à¸´à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ", "à¸„à¸“à¸°à¸šà¸£à¸´à¸«à¸²à¸£à¸˜à¸¸à¸£à¸à¸´à¸ˆ", "à¸§à¸´à¸—à¸¢à¸²à¸¥à¸±à¸¢à¸ªà¸«à¸§à¸´à¸—à¸¢à¸²à¸à¸²à¸£",
    "à¸„à¸“à¸°à¸žà¸¢à¸²à¸šà¸²à¸¥à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹à¸¡à¸„à¸„à¸­à¸£à¹Œà¸¡à¸´à¸„", "à¸„à¸“à¸°à¹€à¸ à¸ªà¸±à¸Šà¸¨à¸²à¸ªà¸•à¸£à¹Œ", "à¸§à¸´à¸—à¸¢à¸²à¸¥à¸±à¸¢à¸™à¸²à¸™à¸²à¸Šà¸²à¸•à¸´",
    "à¸§à¸´à¸—à¸¢à¸²à¸¥à¸±à¸¢à¸”à¸¸à¸£à¸´à¸¢à¸¨à¸´à¸¥à¸›à¹Œ", "à¸§à¸´à¸—à¸¢à¸²à¸¥à¸±à¸¢à¸žà¸£à¸°à¸„à¸£à¸´à¸ªà¸•à¹Œà¸˜à¸£à¸£à¸¡à¹à¸¡à¸„à¸à¸´à¸¥à¸§à¸²à¸£à¸µ",
    "à¸šà¸±à¸“à¸‘à¸´à¸•à¸§à¸´à¸—à¸¢à¸²à¸¥à¸±à¸¢", "à¸ªà¸³à¸™à¸±à¸à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²à¸—à¸±à¹ˆà¸§à¹„à¸›"
]

# ==========================================
# 2. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸£à¸°à¸šà¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¹„à¸Ÿà¸¥à¹Œ
# ==========================================

def check_and_download_font():
    if not os.path.exists(FONT_FILE):
        try:
            response = requests.get(FONT_URL)
            if response.status_code == 200:
                with open(FONT_FILE, "wb") as f: f.write(response.content)
        except: pass

def init_files():
    if not os.path.exists(DB_FILE):
        cols = ["NO", "à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸­à¸­à¸", "à¸§à¸±à¸™", "à¹€à¸”à¸·à¸­à¸™", "à¸›à¸µ", "à¸œà¸¹à¹‰à¸¥à¸‡à¸™à¸²à¸¡", "à¸–à¸¶à¸‡", "à¹€à¸£à¸·à¹ˆà¸­à¸‡", 
                "à¸„à¸“à¸°", "à¸«à¸±à¸§à¸«à¸™à¹‰à¸²à¹‚à¸„à¸£à¸‡à¸à¸²à¸£à¸§à¸´à¸ˆà¸±à¸¢", "à¸œà¸¹à¹‰à¸›à¸£à¸°à¸ªà¸²à¸™", "à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸­à¸™à¸¸à¸¡à¸±à¸•à¸´", 
                "à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™", "à¸Šà¸·à¹ˆà¸­à¹‚à¸„à¸£à¸‡à¸à¸²à¸£", "à¸£à¸«à¸±à¸ªà¸«à¸¡à¸§à¸”", "à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸¡à¸·à¹ˆà¸­", 
                "à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸¡à¸²à¸”à¹‰à¸§à¸¢", "à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™_à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£", "à¸ªà¸±à¹ˆà¸‡à¸ˆà¹ˆà¸²à¸¢à¹ƒà¸«à¹‰", "à¸˜à¸™à¸²à¸„à¸²à¸£", "à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡"]
        pd.DataFrame(columns=cols).to_csv(DB_FILE, index=False, encoding='utf-8-sig')
    if not os.path.exists(TARGET_FILE):
        pd.DataFrame(columns=["year_type", "year", "amount"]).to_csv(TARGET_FILE, index=False, encoding='utf-8-sig')
    check_and_download_font()

def get_current_date():
    now = datetime.now()
    thai_year = now.year + 543
    thai_months = ["à¸¡à¸à¸£à¸²à¸„à¸¡", "à¸à¸¸à¸¡à¸ à¸²à¸žà¸±à¸™à¸˜à¹Œ", "à¸¡à¸µà¸™à¸²à¸„à¸¡", "à¹€à¸¡à¸©à¸²à¸¢à¸™", "à¸žà¸¤à¸©à¸ à¸²à¸„à¸¡", "à¸¡à¸´à¸–à¸¸à¸™à¸²à¸¢à¸™",
                   "à¸à¸£à¸à¸Žà¸²à¸„à¸¡", "à¸ªà¸´à¸‡à¸«à¸²à¸„à¸¡", "à¸à¸±à¸™à¸¢à¸²à¸¢à¸™", "à¸•à¸¸à¸¥à¸²à¸„à¸¡", "à¸žà¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™", "à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡"]
    month_str = thai_months[now.month - 1]
    return now, thai_year, f"{now.day} {month_str} {thai_year}", month_str

def get_next_doc_no():
    try:
        if not os.path.exists(DB_FILE): return "0203/001"
        df = pd.read_csv(DB_FILE, encoding='utf-8-sig')
        if df.empty: return "0203/001"
        df['à¸›à¸µ'] = pd.to_numeric(df['à¸›à¸µ'], errors='coerce').fillna(0).astype(int)
        _, current_year, _, _ = get_current_date()
        if current_year > df['à¸›à¸µ'].max(): return "0203/001"
        last_doc = str(df['à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸­à¸­à¸'].iloc[-1])
        if "/" in last_doc: return f"0203/{int(last_doc.split('/')[-1]) + 1:03d}"
        return "0203/001"
    except: return "0203/001"

def process_data(df):
    if df.empty: return df
    required_cols = ['à¸›à¸µ', 'à¹€à¸”à¸·à¸­à¸™', 'à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™', 'à¸›à¸µà¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“', 'à¸›à¸µà¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²', 'à¸›à¸µà¸›à¸à¸´à¸—à¸´à¸™']
    for col in required_cols:
        if col not in df.columns: df[col] = pd.Series(dtype='float' if col == 'à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™' else 'int')
    df['à¸›à¸µ'] = pd.to_numeric(df['à¸›à¸µ'], errors='coerce').fillna(0).astype(int)
    df['à¹€à¸”à¸·à¸­à¸™'] = pd.to_numeric(df['à¹€à¸”à¸·à¸­à¸™'], errors='coerce').fillna(0).astype(int)
    df['à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™'] = pd.to_numeric(df['à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™'], errors='coerce').fillna(0.0)
    df['à¸›à¸µà¸‡à¸šà¸›à¸£à¸°à¸¡à¸²à¸“'] = df.apply(lambda x: x['à¸›à¸µ'] + 1 if x['à¹€à¸”à¸·à¸­à¸™'] >= 8 else x['à¸›à¸µ'], axis=1)
    df['à¸›à¸µà¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²'] = df.apply(lambda x: x['à¸›à¸µ'] if x['à¹€à¸”à¸·à¸­à¸™'] >= 6 else x['à¸›à¸µ'] - 1, axis=1)
    df['
