import streamlit as st
import pandas as pd
from datetime import datetime
import os
import io
import altair as alt
import requests

# --- Library ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF ---
from pypdf import PdfReader, PdfWriter
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.pagesizes import A4

# ==========================================
# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (Configuration)
# ==========================================
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏°‡∏û‡∏¢.", layout="wide", page_icon="üõ°Ô∏è")

DB_FILE = "database_claims.csv"
TARGET_FILE = "budget_targets.csv"
TEMPLATE_PDF = "‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å.pdf"         
FONT_FILE = "THSarabunNew.ttf"       
FONT_URL = "https://github.com/gungunss/ThaiFonts/raw/master/THSarabunNew.ttf"

# --- üéØ ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (PDF CONFIG) ---
PDF_CONFIG = {
    "faculty":    (150, 740),  
    "doc_no":     (120, 715),  
    "date_day":   (380, 715),  
    "date_month": (430, 715),  
    "date_year":  (500, 715),  
    "subject":    (120, 685),  
    "to_who":     (120, 660),  
    "attach_1":   (140, 635),  
    "check_req":  (75, 605),   
    "amount":     (200, 605),  
    "amount_txt": (350, 605),  
    "pay_to":     (140, 575),  
    "req_d":      (340, 575),  
    "req_m":      (390, 575),  
    "req_y":      (470, 575),  
    "check_bank": (75, 520),   
    "bank_detail":(250, 520),  
    "project":    (210, 490),  
    "faculty_budget": (250, 460), 
    "check_budget": (75, 430), 
    "budget_cat": (180, 430),  
    "leader":     (380, 310),  
    "position":   (380, 285),  
}

# --- Master Data ---
BUDGET_MASTER = {
    "541010001": "‡∏´‡∏°‡∏ß‡∏î‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢", 
    "521130002": "‡∏Ñ‡πà‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£",
    "521130004": "‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", 
    "531111005": "‡∏Ñ‡πà‡∏≤‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞",
    "521140007": "‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô", 
    "531104002": "‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡∏≤‡∏Å‡∏£"
}

FACULTY_MASTER = [
    "‡∏Ñ‡∏ì‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏Ñ‡∏ì‡∏∞‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏™‡∏´‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£",
    "‡∏Ñ‡∏ì‡∏∞‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏°‡∏Ñ‡∏Ñ‡∏≠‡∏£‡πå‡∏°‡∏¥‡∏Ñ", "‡∏Ñ‡∏ì‡∏∞‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏≤‡∏ô‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥",
    "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏î‡∏∏‡∏£‡∏¥‡∏¢‡∏®‡∏¥‡∏•‡∏õ‡πå", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏û‡∏£‡∏∞‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå‡∏ò‡∏£‡∏£‡∏°‡πÅ‡∏°‡∏Ñ‡∏Å‡∏¥‡∏•‡∏ß‡∏≤‡∏£‡∏µ",
    "‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢", "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢", "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£"
]

# ==========================================
# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
# ==========================================

def check_and_download_font():
    if not os.path.exists(FONT_FILE):
        try:
            response = requests.get(FONT_URL)
            if response.status_code == 200:
                with open(FONT_FILE, "wb") as f: 
                    f.write(response.content)
        except: 
            pass

def init_files():
    if not os.path.exists(DB_FILE):
        cols = ["NO", "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å", "‡∏ß‡∏±‡∏ô", "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏õ‡∏µ", "‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏°", "‡∏ñ‡∏∂‡∏á", "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", 
                "‡∏Ñ‡∏ì‡∏∞", "‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢", "‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥", 
                "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", "‡∏£‡∏´‡∏±‡∏™‡∏´‡∏°‡∏ß‡∏î", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠", 
                "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô_‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£", "‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ", "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£", "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"]
        pd.DataFrame(columns=cols).to_csv(DB_FILE, index=False, encoding='utf-8-sig')
    
    if not os.path.exists(TARGET_FILE):
        pd.DataFrame(columns=["year_type", "year", "amount"]).to_csv(TARGET_FILE, index=False, encoding='utf-8-sig')
        
    check_and_download_font()

def get_current_date():
    now = datetime.now()
    thai_year = now.year + 543
    thai_months = [
        "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
        "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
    ]
    month_str = thai_months[now.month - 1]
    return now, thai_year, f"{now.day} {month_str} {thai_year}", month_str

def get_next_doc_no():
    try:
        if not os.path.exists(DB_FILE): 
            return "0203/001"
            
        df = pd.read_csv(DB_FILE, encoding='utf-8-sig')
        if df.empty: 
            return "0203/001"
            
        df['‡∏õ‡∏µ'] = pd.to_numeric(df['‡∏õ‡∏µ'], errors='coerce').fillna(0).astype(int)
        _, current_year, _, _ = get_current_date()
        
        if current_year > df['‡∏õ‡∏µ'].max(): 
            return "0203/001"
            
        last_doc = str(df['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å'].iloc[-1])
        if "/" in last_doc: 
            return f"0203/{int(last_doc.split('/')[-1]) + 1:03d}"
            
        return "0203/001"
    except: 
        return "0203/001"

def process_data(df):
    if df.empty: 
        return df
        
    required_cols = ['‡∏õ‡∏µ', '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', '‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì', '‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡∏õ‡∏µ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô']
    for col in required_cols:
        if col not in df.columns: 
            if col == '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô':
                df[col] = pd.Series(dtype='float')
            else:
                df[col] = pd.Series(dtype='int')
                
    df['‡∏õ‡∏µ'] = pd.to_numeric(df['‡∏õ‡∏µ'], errors='coerce').fillna(0).astype(int)
    df['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'] = pd.to_numeric(df['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'], errors='coerce').fillna(0).astype
